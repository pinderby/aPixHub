define(["jquery","backbone","marionette","globals","../models/RatingModel.min.js","rating-widget","star-rating"],function(e,t,i,o,s,n){return i.Controller.extend({initialize:function(i){this.mediaId=i.mediaId,this.mediaType=i.type,this.source=i.source||"RTM",this.location=i.location||"MOB",this.fbShareEnabled=!1,this.model=new t.Model,this.posting=!1,this.ratingView=n(e("#rating-root").get(0),o,this.onRatingChange.bind(this),this.postReview.bind(this),this.toggleFbShared.bind(this)),o.loginInit.always(function(){o.loginModel.addPersistSignInCallback(this.onLogin.bind(this)),o.loginModel.addPersistSignInFailCallback(this.onFailLogin.bind(this)),o.loginModel.addPersistSignOutCallback(this.onLogout.bind(this))}.bind(this))},onLogin:function(e){if(!this.posting){if("movie"==this.mediaType){var t=new s.MovieCollection;this.model=t.getCurrentUserRating(this.mediaId)}else if("season"==this.mediaType){var i=new s.TvSeasonCollection;this.model=i.getCurrentUserRating(this.mediaId)}else console.log("Rating Controller - invalid type");this.model.deferred&&this.model.deferred.done(function(){this.onDataReceived(e)}.bind(this))}},onLogout:function(){this.fbShareEnabled=!1,this.ratingView.reset(),this.model=new t.Model},onFailLogin:function(e,t){},onDataReceived:function(e){if("function"==typeof e)e();else{var t;t="+"===this.model.get("score")?"wts":"-"===this.model.get("score")?"ni":Number(this.model.get("score"))==this.model.get("score")?"score-"+this.model.get("score"):"none",this.fbShareEnabled=o.loginModel.user.get("facebookShareRatingEnabled"),this.ratingView.setState({ratingState:t,ratingText:this.model.get("review"),isFbUser:o.loginModel.user.isFBUser(),postToFb:o.loginModel.user.get("facebookShareRatingEnabled"),userImg:o.loginModel.user.get("thumbnailUrl")})}},onRatingChange:function(e,t,i){var s=t;"wts"===t?s="+":"ni"===t?s="-":t.startsWith("score-")&&(s=t.substring(6)),"FBK"===o.loginModel.getAuthStatus()&&e&&void 0!==t?(this.model.set("source",this.source),this.model.set("score",s),this.postReviewHelper(this.model.get("review"),s,"Posting score","Posted score"),this.postToFacebook(this.model.get("score"),this.model.get("review")),i(t)):"anon"===o.loginModel.getAuthStatus()?(t.startsWith("score-")?this.onStarPressedNotLogin(s,t,i):this.onWtsNiPressedNotLogin(s,t,i),o.loginView.open()):(this.model.set("source",this.source),this.model.set("score",s),this.postReviewHelper(this.model.get("review"),s,"Posting score","Posted score"),i(t))},onWtsNiPressedNotLogin:function(e,t){o.loginModel.addOneSignInCallback(this.onLogin.bind(this,function(){this.model.set("score",e),this.fbShareEnabled=o.loginModel.user.get("facebookShareRatingEnabled"),this.postReviewHelper(this.model.get("review"),e,"Posting score","Posted score"),this.ratingView.setState({ratingState:t,ratingText:this.model.get("review"),isFbUser:"FBK"===o.loginModel.getAuthStatus(),postToFb:this.fbShareEnabled}),"FBK"===o.loginModel.getAuthStatus()&&this.fbShareEnabled&&this.postToFacebook(e,this.model.get("review")),this.posting=!1}.bind(this))),o.loginModel.addOneSignInFailCallback(function(){setTimeout(function(){this.onWtsNiPressedNotLogin(e,t)}.bind(this),1)}.bind(this))},onStarPressedNotLogin:function(e,t){o.loginModel.addOneSignInCallback(this.onLogin.bind(this,function(){this.model.set("score",e),this.fbShareEnabled=o.loginModel.user.get("facebookShareRatingEnabled"),this.postReviewHelper(this.model.get("review"),e,"Posting star rating","Star rating posted"),this.ratingView.setState({ratingState:t,ratingText:this.model.get("review"),isFbUser:"FBK"===o.loginModel.getAuthStatus(),postToFb:this.fbShareEnabled}),"FBK"===o.loginModel.getAuthStatus()&&this.fbShareEnabled&&this.postToFacebook(e,this.model.get("review")),this.posting=!1}.bind(this))),o.loginModel.addOneSignInFailCallback(function(){setTimeout(function(){this.ratingView.resetStar()}.bind(this),1)}.bind(this))},postReviewHelper:function(t,i,o,s){var n=e(".rating_textbox .rating_textbox-submit-status");n.html(o).show().fadeOut("slow"),this.model.loginAndSave(i,t,this.location,function(){n.html(s).show().fadeOut("slow")})},postReviewNotLogin:function(e){o.loginModel.addOneSignInCallback(this.onLogin.bind(this,function(){this.model.set("review",e),this.fbShareEnabled=o.loginModel.user.get("facebookShareRatingEnabled"),this.postReviewHelper(e,this.model.get("score"),"Posting review","Review posted"),this.ratingView.setState({ratingState:this.model.get("score"),ratingText:e,isFbUser:"FBK"===o.loginModel.getAuthStatus(),postToFb:this.fbShareEnabled}),"FBK"===o.loginModel.getAuthStatus()&&this.postToFacebook(this.model.get("score"),e),this.posting=!1}))},postReview:function(e,t,i){this.model.set("source",this.source),"FBK"===o.loginModel.getAuthStatus()&&e&&void 0!==this.model.get("score")?(this.model.set("review",t),this.postReviewHelper(t,this.model.get("score"),"Posting review","Review posted"),this.postToFacebook(this.model.get("score"),t),i(t)):"anon"==o.loginModel.getAuthStatus()?(this.posting=!0,o.loginView.open(),this.postReviewNotLogin(t)):(this.model.set("review",t),this.postReviewHelper(t,"Posting review","Review posted"),i(t))},removeWtsFromFB:function(t,i){FB.api("/me/video.wants_to_watch",{object:e(this.location).attr("href")},function(e){if(e.data&&e.data.length>0){var o=e.data[0];console.log("Prev action found (id="+o.id+" type="+o.type+"). Deleting."),FB.api("/"+o.id,"delete",function(){console.log(o.type+" deleted"),this.removeRatingFromFB(t,i)}.bind(this))}else console.log("No previous video:wants_to_watch actions found"),this.removeRatingFromFB(t,i)}.bind(this))},removeRatingFromFB:function(t,i){FB.api("/me/video.rates",{object:e(this.location).attr("href")},function(e){if(e.data&&e.data.length>0){var o=e.data[0];console.log("Prev action found (id="+o.id+" type="+o.type+"). Deleting."),FB.api("/"+o.id,"delete",function(){console.log(o.type+" deleted"),this.postRatingToFB(t,i)}.bind(this))}else console.log("No previous video:rates actions found"),this.postRatingToFB(t,i)}.bind(this))},postRatingToFB:function(t,i){var o=e(".rating_textbox-submit-status"),s=!1;"wts"==t||"+"==t?(e(o.get(1)).html("Posting want to see").show().delay(3e3).fadeOut("slow"),e(o.get(0)).html("Posting want to see").show().delay(3e3).fadeOut("slow",function(){var t={"fb:explicitly_shared":!0,expires_in:15768e3};t[this.model.mediaType]=window.location.href,s||(s=!0,FB.api("/me/video.wants_to_watch","post",t,function(t){e(o.get(1)).html("Added to your timeline").show().delay(5e3).fadeOut("slow"),e(o.get(0)).html("Added to your timeline").show().delay(5e3).fadeOut("slow",function(){s=!1,!t||t.error?console.log(t.error.code+":"+t.error.message):console.log(t.id+" : Action was successful")})}))}.bind(this))):"-"===t||"ni"===t||""===t||void 0!=t&&0==parseInt(t)?(e(o.get(1)).html("Removing Facebook action").show().delay(3e3).fadeOut("slow"),e(o.get(0)).html("Removing Facebook action").show().delay(3e3).fadeOut("slow",function(){o.html("Removed from your timeline").show().delay(5e3).fadeOut("slow")})):!isNaN(t)&&isFinite(t)&&(e(o.get(1)).html("Posting "+t+" star rating").show().delay(3e3).fadeOut("slow"),e(o.get(0)).html("Posting "+t+" star rating").show().delay(3e3).fadeOut("slow",function(){var n={"rating:value":t,"rating:scale":5,"rating:normalized_value":t/5,review_text:i,"fb:explicitly_shared":!0,expires_in:2};n[this.model.mediaType]=window.location.href,s||(s=!0,FB.api("/me/video.rates","post",n,function(t){e(o.get(1)).html("Added to your timeline").show().delay(5e3).fadeOut("slow"),e(o.get(0)).html("Added to your timeline").show().delay(5e3).fadeOut("slow",function(){s=!1,!t||t.error?console.log(t.error.code+":"+t.error.message):console.log(t.id+" : Action was successful")})}))}.bind(this)))},postToFacebook:function(e,t){this.fbShareEnabled&&(console.log("Posting to Facebook."),this.removeWtsFromFB(e,t))},toggleFbShared:function(){if("FBK"!==o.loginModel.getAuthStatus())this.signInFacebook();else if(this.fbShareEnabled)this.fbShareEnabled=!this.fbShareEnabled,this.ratingView.setState({postToFb:this.fbShareEnabled});else{var t=confirm("Always share ratings on Facebook?");t?(this.fbShareEnabled=!this.fbShareEnabled,this.ratingView.setState({postToFb:this.fbShareEnabled}),o.loginModel.user.set("facebookShareRatingEnabled",!0),e.post("/user/account/facebook-share-rating-setting/",{facebookId:o.loginModel.user.get("fb_id"),sharingEnabled:!0},"json").complete()):(this.fbShareEnabled=!this.fbShareEnabled,this.ratingView.setState({postToFb:this.fbShareEnabled}))}}})});
//# sourceMappingURL=RatingController.min.js.map